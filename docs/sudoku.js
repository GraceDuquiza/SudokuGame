"use strict";(()=>{if(window.top!==window.self)try{window.top.location.replace(window.location.href)}catch{window.location.replace(window.location.href)}var R=5,ot=!0,Re={beginner:{type:"4x4"},intermediate:{minClues:37,maxClues:44,requireSinglesSolvable:!0,minSearchNodes:80,maxTries:18,maxGenMs:300},advanced:{minClues:28,maxClues:34,requireSinglesSolvable:!1,minSearchNodes:300,maxTries:22,maxGenMs:550},expert:{minClues:19,maxClues:22,requireSinglesSolvable:!1,minSearchNodes:1200,maxTries:36,maxGenMs:1400}},h=e=>document.querySelector(e),st=e=>document.querySelectorAll(e),ee=()=>typeof performance<"u"&&performance.now?performance.now():Date.now();function re(e){let t=Math.max(0,Math.floor(e)),o=Math.floor(t/3600),s=Math.floor(t%3600/60),i=t%60,r=l=>String(l).padStart(2,"0");return o>0?`${r(o)}:${r(s)}:${r(i)}`:`${r(s)}:${r(i)}`}function D(e){return e.slice().sort(()=>Math.random()-.5)}function le(e){let t={};for(let[o,s]of Object.entries(e))t[o]=[...s];return t}function We(e){let t={};for(let[o,s]of Object.entries(e||{}))t[o]=new Set(s);return t}function B(e,t=0){let o=Number(e);return Number.isFinite(o)?o:t}function A(e,t,o,s=t){return e=B(e,s),e<t||e>o?s:e}function te(e,t){let o=t*t;return!Array.isArray(e)||e.length!==o?Array(o).fill(0):e.map(s=>A(s,0,t,0))}function it(e,t){let o=t*t,s={};if(!e||typeof e!="object")return s;for(let[i,r]of Object.entries(e)){let l=B(i,-1);if(l<0||l>=o)continue;let c=new Set;if(Array.isArray(r))for(let u of r){let d=A(u,1,t,0);d&&c.add(d)}c.size&&(s[l]=c)}return s}var n={difficulty:"beginner",size:9,boxSize:3,givens:[],grid:[],solution:[],selected:null,notesMode:!1,notes:{},highlightNumber:null,startTime:null,elapsed:0,timerId:null,hintsUsed:0,hintTarget:null,hintValue:null,mistakes:0,mistakeCells:new Set,gameOver:!1,undoStack:[],redoStack:[],score:0,totalScore:0,puzzleNumber:1,totalPuzzles:20,goodFlash:new Set},T,y,z,M,be,ve,P,pe,ye,Se,$,E,ke,xe,Ce,W,ze,Te,X,K,Oe,we,Ee="sudoku.learn.table.v2",Xe="sudoku.bestTimes.v1",N={beginner:null,intermediate:null,advanced:null,expert:null},q=!1,De=0,G=null;function se(e,t){if(G&&G.N===e&&G.B===t)return G;let o=new Int16Array(e*e),s=new Int16Array(e*e),i=new Int16Array(e*e),r=Array.from({length:e*e},()=>[]);for(let a=0;a<e;a++)for(let g=0;g<e;g++){let m=a*e+g;o[m]=a,s[m]=g;let v=Math.floor(a/t)*t,C=Math.floor(g/t)*t,w=v+Math.floor(g/t);i[m]=v+Math.floor(g/t)+(Math.floor(a/t)*t-v),i[m]=Math.floor(a/t)*t+Math.floor(g/t)}for(let a=0;a<e*e;a++)r[i[a]].push(a);let l=(1<<e)-1,c=a=>1<<a-1;return G={N:e,B:t,ROW_OF:o,COL_OF:s,BOX_OF:i,CELLS_IN_BOX:r,FULL_MASK:l,bit:c,popcount:a=>(a=a-(a>>>1&1431655765),a=(a&858993459)+(a>>>2&858993459),(a+(a>>>4)&252645135)*16843009>>>24),maskToDigits:a=>{let g=[];for(let m=1;m<=e;m++)a&c(m)&&g.push(m);return g}},G}function rt(e,t){let o=new Int16Array(t.N),s=new Int16Array(t.N),i=new Int16Array(t.N);for(let r=0;r<e.length;r++){let l=e[r];if(!l)continue;let c=t.bit(l);o[t.ROW_OF[r]]|=c,s[t.COL_OF[r]]|=c,i[t.BOX_OF[r]]|=c}return{rows:o,cols:s,boxes:i}}function Le(e,t,o){let s=t.rows[o.ROW_OF[e]]|t.cols[o.COL_OF[e]]|t.boxes[o.BOX_OF[e]];return o.FULL_MASK^s}function Ie(e,t,o,s={}){let{countOnly:i=!1,wantMetrics:r=!1,maxSolutions:l=2}=s,c=se(t,o),u=e.slice(),d=rt(u,c),a=[];for(let f=0;f<u.length;f++)u[f]===0&&a.push(f);let g=0,m=0,v=null;function C(){let f=-1,p=1e9;for(let U=0;U<a.length;U++){let Z=a[U];if(u[Z]!==0)continue;let qe=Le(Z,d,c),he=c.popcount(qe);if(he===0)return{i:Z,cm:qe,cnt:0};if(he<p&&(p=he,f=Z),p===1)break}let S=f>=0?Le(f,d,c):0;return{i:f,cm:S,cnt:f>=0?c.popcount(S):0}}function w(f,p){u[f]=p;let S=c.bit(p);d.rows[c.ROW_OF[f]]|=S,d.cols[c.COL_OF[f]]|=S,d.boxes[c.BOX_OF[f]]|=S}function L(f,p){u[f]=0;let S=c.bit(p);d.rows[c.ROW_OF[f]]&=~S,d.cols[c.COL_OF[f]]&=~S,d.boxes[c.BOX_OF[f]]&=~S}function Q(){if(u.every(Boolean))return g++,!i&&!v&&(v=u.slice()),i&&g>=l||!i;let f=C();if(f.i===-1||f.cnt===0)return!1;let p=D(c.maskToDigits(f.cm));for(let S=0;S<p.length;S++){let U=p[S];if(w(f.i,U),m++,Q())return!0;L(f.i,U)}return!1}return Q(),{solved:g>0,solution:v,solutionsCount:g,nodes:r?m:0}}function lt(e,t,o,s=!1){let i=Ie(e,t,o,{countOnly:s,wantMetrics:!1,maxSolutions:2});return{solved:i.solved,solution:i.solution,solutionsCount:i.solutionsCount}}function ct(e,t,o){let s=Ie(e,t,o,{countOnly:!1,wantMetrics:!0,maxSolutions:1});return{solved:s.solved,nodes:s.nodes,solutionsCount:s.solutionsCount}}function ne(e,t,o){return Ie(e,t,o,{countOnly:!0,wantMetrics:!1,maxSolutions:2}).solutionsCount===1}function Ke(e,t){let o=se(e,t),s=Array(e*e).fill(0),i={rows:new Int16Array(e),cols:new Int16Array(e),boxes:new Int16Array(e)},r=D([...Array(e*e).keys()]);function l(){let a=-1,g=1e9,m=0;for(let v=0;v<r.length;v++){let C=r[v];if(s[C]!==0)continue;let w=Le(C,i,o),L=o.popcount(w);if(L===0)return{i:C,cm:w,cnt:0};if(L<g&&(g=L,a=C,m=w),g===1)break}return{i:a,cm:m,cnt:g}}function c(a,g){s[a]=g;let m=o.bit(g);i.rows[o.ROW_OF[a]]|=m,i.cols[o.COL_OF[a]]|=m,i.boxes[o.BOX_OF[a]]|=m}function u(a,g){s[a]=0;let m=o.bit(g);i.rows[o.ROW_OF[a]]&=~m,i.cols[o.COL_OF[a]]&=~m,i.boxes[o.BOX_OF[a]]&=~m}function d(){let a=l();if(a.i===-1)return!0;if(a.cnt===0)return!1;let g=D(o.maskToDigits(a.cm));for(let m=0;m<g.length;m++){let v=g[m];if(c(a.i,v),d())return!0;u(a.i,v)}return!1}return d(),s}function He(e,t){let o=e===4?6:34,s=Ke(e,t),i=D([...Array(e*e).keys()]),r=s.slice(),l=e*e;for(let c=0;c<i.length;c++){let u=i[c];if(r[u]===0)continue;let d=r[u];if(r[u]=0,l--,!ne(r,e,t))r[u]=d,l++;else if(l<=o)break}return{puzzle:r,solution:s}}function at(e,t,o){if(t===4||e==="beginner")return He(t,o);let s=Re[e]||Re.intermediate,i=s.maxTries??20,r=ee()+(s.maxGenMs??500),l=null;for(let c=0;c<i&&!(ee()>r);c++){let u=Ke(t,o),d=u.slice(),a=t*t,g=D([...Array(t*t).keys()]);for(let f of g){if(d[f]===0)continue;let p=d[f];if(d[f]=0,a--,ne(d,t,o)||(d[f]=p,a++),a<=s.minClues||ee()>r)break}let m=D([...Array(t*t).keys()]);for(let f of m){if(d[f]===0)continue;let p=d[f];if(d[f]=0,a--,(!ne(d,t,o)||a<s.minClues)&&(d[f]=p,a++),a<=s.maxClues||ee()>r)break}if(a<s.minClues||a>s.maxClues){let f=s.minClues+s.maxClues>>1;(!l||Math.abs(a-f)<Math.abs(l.clues-f))&&(l={puzzle:d.slice(),solution:u.slice(),clues:a,nodes:0});continue}let v=xt(d,t,o),C=ct(d,t,o);if(!ne(d,t,o))continue;let L=s.requireSinglesSolvable?v.solved:!v.solved,Q=(C.nodes||0)>=(s.minSearchNodes||0);if(L&&Q)return{puzzle:d,solution:u};(!l||C.nodes>(l.nodes||-1))&&(l={puzzle:d.slice(),solution:u.slice(),clues:a,nodes:C.nodes})}return l?{puzzle:l.puzzle,solution:l.solution}:He(t,o)}function I(e,t,o){return e*o+t}function Ne(e,t){let o=Math.floor(e/t);return Array.from({length:t},(s,i)=>I(o,i,t))}function je(e,t){let o=e%t;return Array.from({length:t},(s,i)=>I(i,o,t))}function Fe(e,t,o){let s=Math.floor(e/t),i=e%t,r=Math.floor(s/o)*o,l=Math.floor(i/o)*o,c=[];for(let u=0;u<o;u++)for(let d=0;d<o;d++)c.push(I(r+u,l+d,t));return c}function ut(e,t,o){return new Set(Ne(e,o).map(s=>t[s]).filter(Boolean))}function dt(e,t,o){return new Set(je(e,o).map(s=>t[s]).filter(Boolean))}function ft(e,t,o,s){return new Set(Fe(e,o,s).map(i=>t[i]).filter(Boolean))}function oe(e,t,o,s){if(t[e]!==0)return[];let i=new Set([...ut(e,t,o),...dt(e,t,o),...ft(e,t,o,s)]),r=[];for(let l=1;l<=o;l++)i.has(l)||r.push(l);return r}var O=[],$e=[],ie=[],V=[];function _e(){if(!y||q)return;q=!0;let e=++De,t=n.size,o=n.boxSize;typeof se=="function"&&se(t,o),y.dataset.n=String(t),y.innerHTML=Je(t,o),O=Array.from(y.querySelectorAll("td.cell")),$e=O.map(s=>s.firstElementChild),ie=Array(t*t).fill(void 0),V=Array(t*t).fill(""),requestAnimationFrame(()=>{if(e!==De){q=!1;return}gt(),q=!1,ce()})}function Je(e,t){let o="<colgroup>";for(let s=0;s<e;s++)o+="<col>";o+="</colgroup><tbody>";for(let s=0;s<e;s++){o+="<tr>";for(let i=0;i<e;i++){let r=I(s,i,e),l=(i+1)%t===0&&i!==e-1?" box-right":"",c=(s+1)%t===0&&s!==e-1?" box-bottom":"";o+=`<td class="cell${l}${c}" data-idx="${r}"><div class="cell-inner"></div></td>`}o+="</tr>"}return o+="</tbody>",o}function gt(){if(!y)return;let e=n.size,t=y.querySelectorAll("tbody tr").length,o=y.querySelectorAll("colgroup col").length;(t!==e||o!==e)&&(y.innerHTML=Je(e,n.boxSize),y.dataset.n=String(e),O=Array.from(y.querySelectorAll("td.cell")),$e=O.map(s=>s.firstElementChild),ie=Array(e*e).fill(void 0),V=Array(e*e).fill(""))}function mt(e,t){n.notes[e]||(n.notes[e]=new Set);let o=n.notes[e];o.has(t)?o.delete(t):o.add(t),o.size===0&&delete n.notes[e]}function ht(e,t){let o=e===4,s=o?4:9,i=`<div class="notes ${o?"small":""}">`;for(let r=1;r<=s;r++)i+=`<div class="note">${t.has(r)?r:""}</div>`;return i+="</div>",i}function x(e){if(!O[e])return;let t=O[e],o=$e[e],s=n.size,i=n.grid[e],r=n.givens[e]!==0;t.classList.toggle("prefilled",r),t.classList.toggle("selected",n.selected===e),t.classList.toggle("mistakeNumber",n.mistakeCells.has(e)),t.classList.toggle("hint-highlight",n.hintTarget===e),t.classList.toggle("goodNumber",n.goodFlash.has(e));let l=n.highlightNumber!=null&&i===n.highlightNumber;if(t.classList.toggle("sameNumber",l),ie[e]!==i&&(ie[e]=i,V[e]="",o.textContent=i?String(i):""),i===0){let c=n.notes[e],u=c?[...c].sort().join(","):"";u!==V[e]&&(V[e]=u,o.innerHTML=c&&c.size?ht(s,c):"")}}function ce(){let e=n.size*n.size;for(let t=0;t<e;t++)x(t);de(),fe(),$&&($.textContent=`${n.hintsUsed}/${R}`),E&&(E.textContent=n.mistakes),W&&(W.textContent=`${n.score} (Total: ${n.totalScore})`),Mt(),Me()}function ae(){if(!O.length)return;let e=n.size*n.size;for(let t=0;t<e;t++){let o=O[t],s=n.grid[t];o.classList.toggle("sameNumber",n.highlightNumber!=null&&s===n.highlightNumber)}}function ue(e){n.highlightNumber=n.highlightNumber===e?null:e,ae(),fe()}function Ye(){let e=n.size,t=Array(e+1).fill(e);for(let o=0;o<n.grid.length;o++){let s=n.grid[o];s&&t[s]--}for(let o=1;o<=e;o++)t[o]<0&&(t[o]=0);return t}function de(){if(!z)return;let e=n.size,t=Ye();z.dataset.n=String(e);for(let o=1;o<=e;o++){let s=z.querySelector(`button[data-value="${o}"]`);if(!s)continue;let i=s.querySelector(".remain");i&&(i.textContent=t[o]),s.classList.toggle("exhausted",t[o]===0)}}function fe(){z&&st("#keys button").forEach(e=>{let t=+e.dataset.value;e.classList.toggle("active",t===n.highlightNumber)})}function bt(e){let t=e.target.closest("td.cell");if(!t||!y||!y.contains(t))return;let o=n.selected;n.selected=+t.dataset.idx,o!==null&&x(o),x(n.selected);let s=n.grid[n.selected];s&&ue(s)}function Ae(){n.undoStack.push({grid:n.grid.slice(),notes:le(n.notes),selected:n.selected,score:n.score,highlightNumber:n.highlightNumber}),n.redoStack=[]}function vt(){if(!n.undoStack.length)return b("\u21A9\uFE0F Nothing to undo!");let e=n.undoStack.pop();n.redoStack.push({grid:n.grid.slice(),notes:le(n.notes),selected:n.selected,score:n.score,highlightNumber:n.highlightNumber}),n.grid=e.grid,n.notes=We(e.notes),n.selected=e.selected,n.score=e.score,n.highlightNumber=e.highlightNumber??null,ce(),k(),b("\u21A9\uFE0F Undid your last move.")}function pt(){if(!n.redoStack.length)return b("\u21AA\uFE0F Nothing to redo!");let e=n.redoStack.pop();n.undoStack.push({grid:n.grid.slice(),notes:le(n.notes),selected:n.selected,score:n.score,highlightNumber:n.highlightNumber}),n.grid=e.grid,n.notes=We(e.notes),n.selected=e.selected,n.score=e.score,n.highlightNumber=e.highlightNumber??null,ce(),k(),b("\u21AA\uFE0F Redid your move.")}function Pe(e,t=480){n.goodFlash.add(e),x(e),setTimeout(()=>{n.goodFlash.delete(e),x(e)},t)}function yt(e){let t=n.size,o=n.boxSize,s=n.grid[e];if(s===0)return!0;let i=Ne(e,t).map(u=>n.grid[u]),r=je(e,t).map(u=>n.grid[u]),l=Fe(e,t,o).map(u=>n.grid[u]),c=u=>u.filter(d=>d===s).length===1;return c(i)&&c(r)&&c(l)}function Qe(e){if(n.gameOver||n.selected==null)return;let t=n.selected;if(n.givens[t]!==0){ue(e);return}if(n.notesMode){Ae(),mt(t,e),n.highlightNumber=e,x(t),k();return}let o=Ye(),s=n.grid[t];if(o[e]===0&&s!==e){n.highlightNumber=e,ae(),b(`All ${e}\u2019s are already placed.`);return}if(Ae(),ot){if(e!==n.solution[t]){n.mistakes++,n.mistakeCells.add(t),x(t),setTimeout(()=>{n.mistakeCells.delete(t),x(t)},450),b("\u274C Not the right number for this box. Try again!"),E&&(E.textContent=n.mistakes),Me(),k(),n.mistakes>=5&&Be();return}n.grid[t]=e,n.mistakeCells.delete(t),delete n.notes[t],n.score+=10,Pe(t),b("\u2705 Great! That\u2019s the correct number.")}else if(n.grid[t]=e,yt(t))n.mistakeCells.delete(t),n.score+=10,delete n.notes[t],Pe(t),b("\u2705 Nice choice!");else{if(n.mistakes++,n.mistakeCells.add(t),n.score=Math.max(0,n.score-5),x(t),n.mistakes>=5)return Be();b("\u274C Oops! That number doesn\u2019t fit.")}de(),fe(),$&&($.textContent=`${n.hintsUsed}/${R}`),E&&(E.textContent=n.mistakes),W&&(W.textContent=`${n.score} (Total: ${n.totalScore})`),Me(),k(),zt()}function St(){if(n.gameOver||n.selected==null)return;let e=n.selected;n.givens[e]===0&&(Ae(),n.grid[e]=0,delete n.notes[e],n.mistakeCells.delete(e),x(e),de(),k(),b("\u{1F9FD} Cleared that box."))}function Ze(e,t,o){for(let s=0;s<e.length;s++)if(e[s]===0){let i=oe(s,e,t,o);if(i.length===1)return{idx:s,value:i[0]}}return null}function kt(e,t,o){for(let s=0;s<t;s++){let i=Array.from({length:t},(l,c)=>I(s,c,t)),r=Array(t+1).fill(null).map(()=>[]);for(let l of i)if(e[l]===0)for(let c of oe(l,e,t,o))r[c].push(l);for(let l=1;l<=t;l++)if(r[l].length===1)return{idx:r[l][0],value:l}}for(let s=0;s<t;s++){let i=Array.from({length:t},(l,c)=>I(c,s,t)),r=Array(t+1).fill(null).map(()=>[]);for(let l of i)if(e[l]===0)for(let c of oe(l,e,t,o))r[c].push(l);for(let l=1;l<=t;l++)if(r[l].length===1)return{idx:r[l][0],value:l}}for(let s=0;s<t;s+=o)for(let i=0;i<t;i+=o){let r=I(s,i,t),l=Fe(r,t,o),c=Array(t+1).fill(null).map(()=>[]);for(let u of l)if(e[u]===0)for(let d of oe(u,e,t,o))c[d].push(u);for(let u=1;u<=t;u++)if(c[u].length===1)return{idx:c[u][0],value:u}}return null}function xt(e,t,o){let s=e.slice(),i=0;for(;;){let r=Ze(s,t,o);if(r||(r=kt(s,t,o)),!r)break;s[r.idx]=r.value,i++}return{solved:s.every(r=>r!==0),steps:i}}function Ct(){if(n.gameOver)return;if(n.hintsUsed>=R)return b("\u26A0\uFE0F No more hints!");let e=Ze(n.grid,n.size,n.boxSize);if(!e){let o=[];for(let i=0;i<n.grid.length;i++)n.grid[i]===0&&o.push(i);if(!o.length)return b("\u{1F914} No hints needed!");let s=o[Math.floor(Math.random()*o.length)];e={idx:s,value:n.solution[s]}}let t=n.hintTarget;n.hintsUsed++,n.hintTarget=e.idx,n.hintValue=e.value,t!=null&&x(t),x(e.idx),b(`\u{1F4A1} Hint ${n.hintsUsed}/${R}: This box should be ${e.value}.`),$&&($.textContent=`${n.hintsUsed}/${R}`),k()}function Be(){_(),n.gameOver=!0,b("\u{1F480} Game Over! Out of hearts.");let e=document.createElement("div");e.className="game-over",e.innerHTML=`
    <div class="overlay-box">
      <h2>\u{1F480} GAME OVER</h2>
      <p>Your score: <strong>${n.score}</strong></p>
      <p>Total score: <strong>${n.totalScore}</strong></p>
      <div class="buttons">
        <button id="restartAfter">\u{1F504} Try Again</button>
        <button id="quitGame">Quit</button>
      </div>
    </div>`,document.body.appendChild(e),h("#restartAfter")?.addEventListener("click",()=>{document.body.removeChild(e),n.score=0,J()}),h("#quitGame")?.addEventListener("click",()=>{document.body.removeChild(e),n.score=0,n.totalScore=0,me(),b("\u{1F44B} Thanks for playing! Start a new game when ready.")})}function zt(){if(n.grid.length&&n.grid.every((e,t)=>e!==0&&e===n.solution[t])){_(),n.score+=100,n.totalScore+=n.score;let e=n.elapsed;At(n.difficulty,e)&&b(`\u{1F3C5} New personal best: ${re(e)}!`);let t=document.createElement("div");t.className="game-over",t.innerHTML=`
      <div class="overlay-box">
        <h2>\u{1F389} You solved it!</h2>
        <p>Score this game: <strong>${n.score}</strong></p>
        <p>Total Score: <strong>${n.totalScore}</strong></p>
        <div class="buttons">
          <button id="nextChallenge">Next Challenge</button>
          <button id="quitGame">Quit</button>
        </div>
      </div>`,document.body.appendChild(t),h("#nextChallenge")?.addEventListener("click",()=>{document.body.removeChild(t),n.score=0,n.puzzleNumber++,J()}),h("#quitGame")?.addEventListener("click",()=>{document.body.removeChild(t),n.score=0,n.totalScore=0,me(),b("\u{1F44B} Thanks for playing! Start a new game when ready.")}),k()}}function Ue(e){Te&&(Te.textContent=e)}function Y(){if(!X||!K)return;let e=!!n.timerId;X.hidden=!e,K.hidden=e}function j(){let e=n.elapsed+(n.startTime?Math.floor((Date.now()-n.startTime)/1e3):0);Ue(re(e))}function et(){_(),n.startTime=Date.now(),n.timerId=setInterval(j,1e3),j(),Y()}function _(){n.timerId&&(clearInterval(n.timerId),n.timerId=null,n.elapsed+=Math.floor((Date.now()-n.startTime)/1e3),n.startTime=null,j(),k()),Y()}function tt(){n.timerId||(n.startTime=Date.now(),n.timerId=setInterval(j,1e3),j(),Y())}function ge(){_(),n.elapsed=0,Ue("00:00"),k(),Y()}function b(e){xe&&(xe.textContent=e)}function Me(){if(!ke)return;let e=5,t=Math.max(0,e-n.mistakes);ke.textContent="\u2764".repeat(t)+"\u2661".repeat(e-t)}function k(){let e={difficulty:n.difficulty,size:n.size,givens:n.givens,grid:n.grid,solution:n.solution,notes:le(n.notes),elapsed:n.elapsed+(n.startTime?Math.floor((Date.now()-n.startTime)/1e3):0),hintsUsed:n.hintsUsed,hintTarget:n.hintTarget,mistakes:n.mistakes,mistakeCells:[...n.mistakeCells],score:n.score,totalScore:n.totalScore,puzzleNumber:n.puzzleNumber};try{localStorage.setItem(Ee,JSON.stringify(e))}catch{}}function Tt(e,t,o){let s=lt(e,t,o,!1);return s.solved&&s.solution?s.solution:null}function Ot(){let e=localStorage.getItem(Ee);if(!e){let t=localStorage.getItem("sudoku.learn.table.v1");t&&(e=t)}if(!e)return!1;try{let t=JSON.parse(e);n.difficulty=t.difficulty==="beginner"||t.difficulty==="intermediate"||t.difficulty==="advanced"||t.difficulty==="expert"?t.difficulty:"beginner",F(n.difficulty);let o=n.size;if(n.givens=te(t.givens,o),n.grid=te(t.grid,o),n.notes=it(t.notes,o),n.elapsed=B(t.elapsed,0),n.hintsUsed=A(t.hintsUsed,0,R,0),n.hintTarget=typeof t.hintTarget=="number"?A(t.hintTarget,0,o*o-1,null):null,n.mistakes=A(t.mistakes,0,999,0),n.mistakeCells=new Set(Array.isArray(t.mistakeCells)?t.mistakeCells.map(s=>A(s,0,o*o-1,-1)).filter(s=>s>=0):[]),n.score=B(t.score,0),n.totalScore=B(t.totalScore,0),n.puzzleNumber=A(t.puzzleNumber,1,9999,1),Array.isArray(t.solution)&&t.solution.length===o*o)n.solution=te(t.solution,o);else{let s=Tt(n.givens,o,n.boxSize);if(s)n.solution=te(s,o);else return!1}return T&&(T.value=n.difficulty),!0}catch{return!1}}function me(){try{localStorage.removeItem(Ee)}catch{}n.score=0,n.totalScore=0,n.puzzleNumber=1,F(n.difficulty),ce(),b("\u{1F5D1}\uFE0F Progress cleared. Starting fresh!")}function wt(){try{let e=localStorage.getItem(Xe);e&&(N={...N,...JSON.parse(e)})}catch{}}function Lt(){try{localStorage.setItem(Xe,JSON.stringify(N))}catch{}}function nt(e){let t=N[e];return typeof t=="number"&&t>=0?t:null}function At(e,t){let o=nt(e);return o==null||t<o?(N[e]=t,Lt(),H(),!0):!1}function H(){if(!we)return;let e=nt(n.difficulty);we.textContent=e==null?"\u2014":re(e)}function F(e){e==="beginner"?(n.size=4,n.boxSize=2):(n.size=9,n.boxSize=3)}function Mt(){if(!ze)return;let e={beginner:"\u{1F331} Beginner",intermediate:"\u2B50 Intermediate",advanced:"\u{1F525} Advanced",expert:"\u{1F3C6} Expert"};ze.textContent=`${e[n.difficulty]||n.difficulty} \u2014 Puzzle ${n.puzzleNumber} of ${n.totalPuzzles}`}function J(){q||(b("\u23F3 Generating puzzle\u2026"),setTimeout(()=>{ge(),Object.assign(n,{hintsUsed:0,hintTarget:null,hintValue:null,mistakes:0,mistakeCells:new Set,gameOver:!1,undoStack:[],redoStack:[],score:0,notes:{},highlightNumber:null,goodFlash:new Set}),F(n.difficulty);let{puzzle:e,solution:t}=at(n.difficulty,n.size,n.boxSize);n.givens=e.slice(),n.grid=e.slice(),n.solution=t.slice(),M&&(M.disabled=!0),_e(),Ge(),et(),k(),H(),setTimeout(()=>{M&&(M.disabled=!1)},300),b("\u{1F3B2} New puzzle ready!")},0))}function Et(){q||(ge(),Object.assign(n,{grid:n.givens.slice(),mistakes:0,mistakeCells:new Set,hintsUsed:0,hintTarget:null,hintValue:null,gameOver:!1,undoStack:[],redoStack:[],score:0,notes:{},highlightNumber:null,goodFlash:new Set}),_e(),Ge(),et(),k(),H())}function Ge(){if(!z)return;z.innerHTML="";let e=n.size;z.dataset.n=String(e);for(let t=1;t<=e;t++){let o=document.createElement("button");o.innerHTML=`<div class="digit">${t}</div><div class="remain">0</div>`,o.dataset.value=String(t),o.addEventListener("click",()=>{let s=n.selected;if(!(s!=null&&n.givens[s]===0)){ue(t);return}Qe(t),n.highlightNumber=t,ae()}),z.appendChild(o)}de(),fe()}document.addEventListener("keydown",e=>{if(e.code==="Space"){e.preventDefault(),n.timerId?_():tt();return}if(e.code==="KeyS"&&e.shiftKey){e.preventDefault(),ge();return}let t=Number(e.key);if(!Number.isInteger(t)||t<1||t>n.size)return;let o=n.selected;if(!(o!=null&&n.givens[o]===0)){ue(t);return}Qe(t),n.highlightNumber=t,ae()});function It(){T=h("#difficulty"),y=h("#gridTable"),z=h("#keys"),M=h("#newGame"),be=h("#restartGame"),ve=h("#hintBtn"),P=h("#notesToggle"),pe=h("#eraseBtn"),ye=h("#undoBtn"),Se=h("#redoBtn"),$=h("#hintsUsed"),E=h("#mistakes"),ke=h("#lives"),xe=h("#coachMsg"),Ce=h("#clearProgress"),W=h("#score"),ze=h("#challengeLabel"),Te=h("#clock"),X=h("#btn-pause")||h("#btnPause"),K=h("#btn-resume")||h("#btnResume"),Oe=h("#btn-stop")||h("#btnStop"),we=h("#bestTime")}function Ft(){y&&y.addEventListener("click",bt),M&&M.addEventListener("click",J),be&&be.addEventListener("click",Et),ve&&ve.addEventListener("click",Ct),pe&&pe.addEventListener("click",St),ye&&ye.addEventListener("click",vt),Se&&Se.addEventListener("click",pt),X&&X.addEventListener("click",_),K&&K.addEventListener("click",tt),Oe&&Oe.addEventListener("click",ge),P&&P.addEventListener("click",()=>{n.notesMode=!n.notesMode,P.textContent=`Notes: ${n.notesMode?"On":"Off"}`,P.setAttribute("aria-pressed",String(n.notesMode)),b(n.notesMode?"\u{1F4DD} Notes ON: Tap a box, then tap numbers to make tiny helper notes.":"\u{1F446} Notes OFF: Tap a box, then tap a number to place it.")}),T&&T.addEventListener("change",()=>{n.difficulty=T.value,F(n.difficulty),n.puzzleNumber=1,H(),J()}),Ce&&Ce.addEventListener("click",()=>{me(),b("Save cleared")}),document.addEventListener("visibilitychange",()=>{document.hidden&&n.timerId&&_()}),window.addEventListener("beforeunload",k)}function Ve(){It(),wt();let e=Ot();F(n.difficulty),H(),[4,9].includes(n.size)||(n.difficulty="beginner",F(n.difficulty),me(),H()),Ft(),e?(_e(),Ge(),Ue(re(n.elapsed)),Y()):(T&&T.value&&(n.difficulty=T.value),F(n.difficulty),J())}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Ve,{once:!0}):Ve();})();
